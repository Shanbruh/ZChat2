<!DOCTYPE html>
<html lang="en" class="theme-midnight">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" id="theme-meta" content="#0f172a">
    <title>Nexus X | Secure P2P</title>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Theme Variables */
        .theme-midnight { --accent: #6366f1; --bg: #0f172a; --panel: rgba(30, 41, 59, 0.6); --text: #f1f5f9; }
        .theme-neon { --accent: #00f2ff; --bg: #050505; --panel: rgba(20, 20, 20, 0.8); --text: #00f2ff; }
        .theme-rose { --accent: #fb7185; --bg: #2d0b13; --panel: rgba(76, 15, 29, 0.5); --text: #fff1f2; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            height: 100dvh;
            transition: background-color 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass {
            background: var(--panel);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .accent-bg { background-color: var(--accent); }
        .accent-text { color: var(--accent); }
        .accent-border { border-color: var(--accent); }

        /* Component Enhancements */
        .msg-bubble { max-width: 75%; padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; line-height: 1.5; }
        .msg-sent { background: var(--accent); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px -3px var(--accent); }
        .msg-received { background: rgba(255,255,255,0.08); border-bottom-left-radius: 4px; }
        
        .system-log { 
            align-self: center; background: rgba(0,0,0,0.2); 
            padding: 4px 12px; border-radius: 10px; font-size: 0.7rem; 
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.6;
            margin: 10px 0; border: 1px solid rgba(255,255,255,0.05);
        }

        .nav-btn { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 14px; transition: all 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-1px); }

        /* Layout Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .view-animate { animation: fadeIn 0.3s ease-out forwards; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body class="flex items-center justify-center">

    <!-- Auth Module: Password + ID -->
    <div id="authOverlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-xl">
        <div class="glass p-10 rounded-[2.5rem] w-full max-w-sm text-center view-animate">
            <div class="w-20 h-20 accent-bg rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl">
                <i class="fas fa-microchip text-3xl text-white"></i>
            </div>
            <h1 class="text-3xl font-black tracking-tighter mb-2">NEXUS<span class="opacity-50 italic">X</span></h1>
            <p class="text-slate-500 text-xs mb-8 uppercase tracking-widest font-bold">Secure Node Authentication</p>

            <div id="loginForm" class="space-y-4">
                <input type="text" id="nodeIdLogin" placeholder="Node ID" class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 focus:outline-none focus:accent-border transition-all">
                <input type="password" id="nodePassLogin" placeholder="Vault Key" class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 focus:outline-none focus:accent-border transition-all">
                <button onclick="vaultLogin()" class="w-full accent-bg text-white font-black py-4 rounded-2xl shadow-xl hover:opacity-90 transition-all">DECRYPT SESSION</button>
                <p class="text-xs text-slate-500 mt-4">Node not found? <button onclick="toggleAuth(false)" class="accent-text font-bold">Register Alias</button></p>
            </div>

            <div id="regForm" class="hidden space-y-4">
                <input type="text" id="regName" placeholder="Display Name" class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 focus:outline-none focus:accent-border">
                <input type="text" id="regId" placeholder="Desired Node ID" class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 focus:outline-none focus:accent-border">
                <input type="password" id="regPass" placeholder="Vault Key (Password)" class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 focus:outline-none focus:accent-border">
                <button onclick="vaultRegister()" class="w-full accent-bg text-white font-black py-4 rounded-2xl shadow-xl">GENERATE NODE</button>
                <p class="text-xs text-slate-500 mt-4">Known node? <button onclick="toggleAuth(true)" class="accent-text font-bold">Sign In</button></p>
            </div>
        </div>
    </div>

    <!-- Main Application UI -->
    <div id="nexusApp" class="hidden w-full h-full p-2 sm:p-6 flex gap-6 max-w-7xl view-animate">
        
        <!-- Sidebar Navigation -->
        <aside class="glass w-20 rounded-[2rem] flex flex-col items-center py-8 gap-6 hidden md:flex">
            <div class="accent-text text-2xl mb-4"><i class="fas fa-atom"></i></div>
            <button onclick="setView('chats')" class="nav-btn accent-text bg-white/5"><i class="fas fa-comment-alt"></i></button>
            <button onclick="setView('profile')" class="nav-btn text-slate-500 hover:text-white"><i class="fas fa-user-edit"></i></button>
            <div class="mt-auto flex flex-col gap-4">
                <button onclick="cycleTheme()" class="nav-btn text-slate-500"><i class="fas fa-palette"></i></button>
                <button onclick="terminateSession()" class="nav-btn text-red-500"><i class="fas fa-power-off"></i></button>
            </div>
        </aside>

        <!-- Main Panel (Contacts + Chat) -->
        <div class="flex-1 flex gap-6">
            <!-- Sidebar Drawer (Contacts) -->
            <div id="contactPanel" class="glass w-full sm:w-80 rounded-[2rem] flex flex-col overflow-hidden">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-black">STREAMS</h2>
                        <button onclick="linkNewNode()" class="w-8 h-8 rounded-xl accent-bg flex items-center justify-center text-white"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                    <div class="relative">
                        <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 text-xs"></i>
                        <input type="text" placeholder="Search decrypted..." class="w-full bg-white/5 rounded-xl py-2.5 pl-10 pr-4 text-xs focus:outline-none">
                    </div>
                </div>
                
                <div id="contactList" class="flex-1 overflow-y-auto px-4 space-y-2 custom-scroll">
                    <!-- Dynamic -->
                </div>

                <!-- Active Profile Bottom Bar -->
                <div class="p-4 bg-white/5 mt-auto flex items-center gap-3">
                    <div id="userAvatar" class="w-10 h-10 rounded-xl accent-bg flex items-center justify-center font-black text-white">?</div>
                    <div class="flex-1 min-w-0">
                        <p id="userName" class="text-xs font-black truncate">---</p>
                        <p id="userId" class="text-[9px] opacity-40 font-mono"></p>
                    </div>
                </div>
            </div>

            <!-- Chat Main -->
            <main id="chatMain" class="hidden sm:flex glass flex-1 rounded-[2rem] flex-col overflow-hidden relative">
                <div id="emptyView" class="absolute inset-0 z-10 bg-slate-900/40 backdrop-blur-md flex flex-col items-center justify-center">
                    <div class="w-20 h-20 rounded-full border border-white/10 flex items-center justify-center mb-4 text-white/10">
                        <i class="fas fa-fingerprint text-4xl"></i>
                    </div>
                    <p class="text-[10px] font-black tracking-[0.3em] text-slate-500 uppercase">Awaiting Connection</p>
                </div>

                <!-- Chat Header -->
                <header class="p-6 border-b border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleMobileSidebar(false)" class="sm:hidden text-slate-400"><i class="fas fa-chevron-left"></i></button>
                        <div id="chatAvatar" class="w-12 h-12 rounded-2xl glass flex items-center justify-center font-black accent-text text-xl border border-white/10">?</div>
                        <div>
                            <h3 id="chatTitle" class="font-bold">Node Session</h3>
                            <p id="chatStatus" class="text-[9px] font-black text-green-500 uppercase tracking-widest flex items-center gap-1.5"><span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> Secure P2P</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="startNexusCall(false)" class="nav-btn glass text-slate-300 hover:accent-text"><i class="fas fa-phone"></i></button>
                        <button onclick="startNexusCall(true)" class="nav-btn glass text-slate-300 hover:accent-text"><i class="fas fa-video"></i></button>
                    </div>
                </header>

                <!-- Messages Feed -->
                <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scroll flex flex-col">
                    <!-- Logs & Text JS -->
                </div>

                <!-- Input Footer -->
                <div class="p-6">
                    <div class="glass rounded-2xl p-2 flex items-center gap-2">
                        <button class="w-10 h-10 text-slate-400 hover:text-indigo-400"><i class="fas fa-paperclip"></i></button>
                        <input type="text" id="msgIn" placeholder="Enter encrypted text..." class="flex-1 bg-transparent border-none text-sm px-2 focus:outline-none">
                        <button onclick="sendNexusMsg()" class="w-10 h-10 accent-bg text-white rounded-xl shadow-lg shadow-indigo-500/30 flex items-center justify-center transition-transform active:scale-90">
                            <i class="fas fa-paper-plane text-xs"></i>
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Calls UI (Overlays the screen) -->
    <div id="callOverlay" class="hidden fixed inset-0 z-[200] bg-black flex flex-col animate-fadeIn">
        <video id="remoteVideo" class="flex-1 w-full object-cover scale-x-[-1]" autoplay></video>
        <div class="absolute top-10 right-10 w-44 aspect-video rounded-3xl overflow-hidden border-2 border-white/10 shadow-2xl glass">
            <video id="localVideo" class="w-full h-full object-cover scale-x-[-1]" autoplay muted></video>
        </div>
        <div class="absolute bottom-16 left-1/2 -translate-x-1/2 flex items-center gap-6 glass px-10 py-6 rounded-[2.5rem] shadow-2xl">
            <button onclick="toggleCallDev('audio')" id="micBtn" class="w-12 h-12 rounded-full glass flex items-center justify-center"><i class="fas fa-microphone"></i></button>
            <button onclick="hangNexusCall()" class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center text-white text-2xl shadow-lg ring-8 ring-red-500/10"><i class="fas fa-phone-slash"></i></button>
            <button onclick="toggleCallDev('video')" id="camBtn" class="w-12 h-12 rounded-full glass flex items-center justify-center"><i class="fas fa-video"></i></button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 z-[300] bg-white/10 backdrop-blur-md px-6 py-3 rounded-2xl border border-white/20 text-xs font-bold uppercase tracking-widest shadow-2xl transition-all translate-y-[-100px] opacity-0 pointer-events-none">
        <span id="toastMsg">---</span>
    </div>

    <!-- App Logic -->
    <script type="module">
        // Real-world P2P Reliability Config
        const PEER_CONFIG = {
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            }
        };

        let peer, myId, userVault, activePeer;
        let connections = {}, messages = {}, contacts = {};
        let currentCall, localStream;

        // --- AUTH & VAULT LOGIC ---
        window.toggleAuth = (login) => {
            document.getElementById('loginForm').classList.toggle('hidden', !login);
            document.getElementById('regForm').classList.toggle('hidden', login);
        }

        window.vaultRegister = () => {
            const name = document.getElementById('regName').value.trim();
            const id = document.getElementById('regId').value.trim().toLowerCase();
            const pass = document.getElementById('regPass').value;

            if(!name || !id || !pass) return showToast("All nodes require data.");

            const vault = JSON.parse(localStorage.getItem('nexus_vault') || '{}');
            if(vault[id]) return showToast("Node ID already claimed.");

            vault[id] = { name, id, pass, theme: 'theme-midnight', avatar: null };
            localStorage.setItem('nexus_vault', JSON.stringify(vault));
            showToast("Node Initialized. Authenticate.");
            toggleAuth(true);
        }

        window.vaultLogin = () => {
            const id = document.getElementById('nodeIdLogin').value.trim().toLowerCase();
            const pass = document.getElementById('nodePassLogin').value;

            const vault = JSON.parse(localStorage.getItem('nexus_vault') || '{}');
            const user = vault[id];

            if(user && user.pass === pass) {
                userVault = user;
                myId = id;
                localStorage.setItem('nexus_session', id);
                launchNexus();
            } else {
                showToast("Access Denied.");
            }
        }

        // --- THEME ENGINE ---
        const themes = ['theme-midnight', 'theme-neon', 'theme-rose'];
        window.cycleTheme = () => {
            let idx = themes.indexOf(document.documentElement.className);
            let next = themes[(idx + 1) % themes.length];
            document.documentElement.className = next;
            userVault.theme = next;
            updateVault();
            
            const colors = {'theme-midnight': '#0f172a', 'theme-neon': '#050505', 'theme-rose': '#2d0b13'};
            document.getElementById('theme-meta').setAttribute('content', colors[next]);
        }

        // --- CORE P2P ---
        function launchNexus() {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('nexusApp').classList.remove('hidden');

            // Setup Profile UI
            document.getElementById('userName').innerText = userVault.name;
            document.getElementById('userId').innerText = `ID: ${userVault.id}`;
            document.getElementById('userAvatar').innerText = userVault.name.charAt(0).toUpperCase();
            document.documentElement.className = userVault.theme || 'theme-midnight';

            // Load Local History
            contacts = JSON.parse(localStorage.getItem(`nx_contacts_${myId}`) || '{}');
            messages = JSON.parse(localStorage.getItem(`nx_history_${myId}`) || '{}');

            peer = new Peer(myId, PEER_CONFIG);
            
            peer.on('open', (id) => console.log("Nexus Node Active:", id));
            peer.on('connection', (conn) => initConn(conn));
            peer.on('call', (call) => incomingNexusCall(call));
            
            renderContacts();
        }

        function initConn(conn) {
            const pid = conn.peer;
            connections[pid] = conn;

            conn.on('open', () => {
                if(!contacts[pid]) contacts[pid] = { name: pid, id: pid };
                conn.send({ type: 'handshake', name: userVault.name });
                renderContacts();
            });

            conn.on('data', (data) => {
                if(data.type === 'handshake') {
                    contacts[pid].name = data.name;
                    syncStorage();
                    renderContacts();
                } else if(data.type === 'text') {
                    pushMessage(pid, pid, data.text, 'text');
                } else if(data.type === 'log') {
                    pushMessage(pid, pid, data.text, 'log');
                }
            });
        }

        // --- CHAT & LOGS ---
        function pushMessage(chatId, from, content, type) {
            if(!messages[chatId]) messages[chatId] = [];
            messages[chatId].push({
                from, content, type,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
            });
            syncStorage();
            if(activePeer === chatId) renderMessages();
        }

        window.sendNexusMsg = () => {
            const input = document.getElementById('msgIn');
            const val = input.value.trim();
            if(!val || !activePeer) return;

            const conn = connections[activePeer];
            if(conn && conn.open) conn.send({ type: 'text', text: val });

            pushMessage(activePeer, 'me', val, 'text');
            input.value = '';
        }

        // --- CALLS & SYSTEM LOGS ---
        window.startNexusCall = async (video) => {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video });
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('callOverlay').classList.remove('hidden');
                
                currentCall = peer.call(activePeer, localStream, { metadata: { name: userVault.name, video } });
                
                // Real-time System Log
                const logMsg = `ðŸ“ž Link Origin: ${video?'Video':'Voice'} Session Initiated`;
                pushMessage(activePeer, 'me', logMsg, 'log');
                connections[activePeer]?.send({ type: 'log', text: `ðŸ“ž Incoming Link: ${video?'Video':'Voice'} Stream` });

                handleCallFlow(currentCall);
            } catch(e) { showToast("Media Decryption Error."); }
        }

        function incomingNexusCall(call) {
            if(confirm(`Incoming Link Request from ${call.metadata.name}. Accept?`)) {
                navigator.mediaDevices.getUserMedia({ audio: true, video: call.metadata.video })
                    .then(stream => {
                        localStream = stream;
                        document.getElementById('localVideo').srcObject = localStream;
                        document.getElementById('callOverlay').classList.remove('hidden');
                        call.answer(stream);
                        handleCallFlow(call);
                    });
            } else {
                call.close();
            }
        }

        function handleCallFlow(call) {
            call.on('stream', (remote) => document.getElementById('remoteVideo').srcObject = remote);
            call.on('close', () => hangNexusCall());
        }

        window.hangNexusCall = () => {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('callOverlay').classList.add('hidden');
            if(currentCall) currentCall.close();
            pushMessage(activePeer, 'me', "âŒ› Link Terminated", 'log');
        }

        // --- UI DRAWING ---
        function renderContacts() {
            const list = document.getElementById('contactList');
            list.innerHTML = '';
            Object.values(contacts).forEach(c => {
                const active = activePeer === c.id;
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl flex items-center gap-3 cursor-pointer transition-all ${active ? 'bg-white/10 accent-border border' : 'hover:bg-white/5'}`;
                div.onclick = () => selectSession(c.id);
                div.innerHTML = `
                    <div class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center font-black accent-text">${c.name.charAt(0).toUpperCase()}</div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-bold truncate">${c.name}</h4>
                        <p class="text-[9px] opacity-40 uppercase tracking-tighter">${c.id}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function selectSession(pid) {
            activePeer = pid;
            document.getElementById('emptyView').classList.add('hidden');
            document.getElementById('chatMain').classList.remove('hidden');
            document.getElementById('chatMain').classList.add('flex');
            
            document.getElementById('chatTitle').innerText = contacts[pid].name;
            document.getElementById('chatAvatar').innerText = contacts[pid].name.charAt(0).toUpperCase();

            if(!connections[pid] || !connections[pid].open) {
                const conn = peer.connect(pid);
                initConn(conn);
            }
            renderMessages();
            renderContacts();
        }

        function renderMessages() {
            const div = document.getElementById('messages');
            div.innerHTML = '';
            (messages[activePeer] || []).forEach(m => {
                const isMe = m.from === 'me';
                const el = document.createElement('div');
                if(m.type === 'log') {
                    el.className = "system-log";
                    el.innerText = m.content;
                } else {
                    el.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
                    el.innerHTML = `
                        <div class="msg-bubble ${isMe ? 'msg-sent' : 'msg-received'}">
                            ${m.content}
                            <span class="text-[9px] opacity-40 block mt-1 text-right">${m.time}</span>
                        </div>
                    `;
                }
                div.appendChild(el);
            });
            div.scrollTop = div.scrollHeight;
        }

        // --- UTILS ---
        function syncStorage() {
            localStorage.setItem(`nx_contacts_${myId}`, JSON.stringify(contacts));
            localStorage.setItem(`nx_history_${myId}`, JSON.stringify(messages));
        }

        function updateVault() {
            const vault = JSON.parse(localStorage.getItem('nexus_vault') || '{}');
            vault[myId] = userVault;
            localStorage.setItem('nexus_vault', JSON.stringify(vault));
        }

        window.showToast = (msg) => {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-[-100px]');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-100px]'), 3000);
        }

        window.linkNewNode = () => {
            const id = prompt("Node Identifier:");
            if(id && id !== myId) {
                contacts[id] = { id, name: id };
                selectSession(id);
            }
        }

        window.terminateSession = () => {
            localStorage.removeItem('nexus_session');
            location.reload();
        }

        // Persistent Login Check
        const session = localStorage.getItem('nexus_session');
        if(session) {
            const vault = JSON.parse(localStorage.getItem('nexus_vault') || '{}');
            if(vault[session]) {
                userVault = vault[session];
                myId = session;
                launchNexus();
            }
        }
    </script>
</body>
</html>
